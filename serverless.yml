# 服务名称：基于无服务器架构的web3身份验证系统
service: serverless-web3-auth

provider:
  name: aws
  region: ap-northeast-1
  runtime: nodejs20.x
  architecture: arm64
  stage: ${opt:stage,'staging'}

  # 环境变量配置
  environment:
    NODE_ENV: production
    JWT_SECRET: ${env:JWT_SECRET, 'your-default-secret-key'}
    JWT_EXPIRATION: ${env:JWT_EXPIRATION, '24h'}
    DB_HOST: ${cf:web3-auth-infra-${self:provider.stage}.DatabaseEndpoint}
    DB_PORT: 5432
    DB_USERNAME: postgres
    DB_PASSWORD: ${env:DB_PASSWORD, 'MySecurePassword123!'}
    DB_DATABASE: web3_auth_db
    DB_SYNC: true
    REDIS_HOST: ${cf:web3-auth-infra-${self:provider.stage}.RedisEndpoint}
    REDIS_PORT: 6379
    REDIS_PASSWORD: ${env:REDIS_PASSWORD, ''}
    AWS_REGION: ${self:provider.region}

  # IAM 角色配置
  iam:
    role: ${cf:web3-auth-infra-${self:provider.stage}.LambdaExecutionRoleArn}

  # VPC 配置
  vpc:
    securityGroupIds:
      - ${cf:web3-auth-infra-${self:provider.stage}.AppSecurityGroupId}
    subnetIds:
      - ${cf:web3-auth-infra-${self:provider.stage}.PrivateSubnet1Id}
      - ${cf:web3-auth-infra-${self:provider.stage}.PrivateSubnet2Id}

  # ECR 镜像配置
  ecr:
    images:
      serverlessWeb3Auth:
        platform: linux/arm64
        path: ./

# Lambda 函数配置
functions:
  api:
    image:
      name: serverlessWeb3Auth
    url: true
    timeout: 30
    memorySize: 512
    reservedConcurrency: 10 # 限制并发，避免过高费用
    events:
      - httpApi: '*'

# 插件配置
plugins:
  - serverless-offline

# 自定义配置
custom:
  # 本地开发配置
  serverless-offline:
    httpPort: 3000
    noPrependStageInUrl: true
